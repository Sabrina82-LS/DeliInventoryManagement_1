@page "/stock"
@rendermode InteractiveServer

@using DeliInventoryManagement_1.Blazor.Models.V5
@using DeliInventoryManagement_1.Blazor.Services
@inject IDashboardService DashboardService

<div class="stock-wrap">
    <h1 class="stock-title">Stock</h1>

    <!-- Filters -->
    <section class="filters-grid">
        <div class="filter-card">
            <label class="form-label">Search by product name</label>
            <input class="form-control"
                   placeholder="Type a product name..."
                   @bind="searchText"
                   @bind:event="oninput" />
        </div>

        <div class="filter-card">
            <label class="form-label">Filter by category</label>
            <select class="form-select" @bind="selectedCategoryId">
                <option value="">All categories</option>
                @foreach (var c in categories)
                {
                    <option value="@c.Id">@c.Name</option>
                }
            </select>
        </div>

        <div class="actions">
            <button type="button"
                    class="btn-pill btn-apply"
                    @onclick="LoadStockAsync"
                    disabled="@isLoading">
                Apply
            </button>

            <button type="button"
                    class="btn-pill"
                    @onclick="ResetFilters"
                    disabled="@isLoading">
                Clear
            </button>

            <button type="button"
                    class="btn-pill btn-outline"
                    @onclick="RefreshAsync"
                    disabled="@isLoading">
                Refresh
            </button>
        </div>
    </section>

    <!-- States -->
    @if (isLoading)
    {
        <div class="panel">
            <p class="muted">Loading stock...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="panel panel-danger">
            <strong>Error:</strong> @errorMessage
        </div>
    }
    else
    {
        <!-- Table panel -->
        <div class="table-panel">
            <table class="table table-striped table-sm align-middle mb-0">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Product</th>
                        <th>Category</th>
                        <th class="text-end">Cost</th>
                        <th class="text-end">Price</th>
                        <th class="text-end">Reorder</th>
                        <th class="text-end">Quantity</th>
                        <th class="text-center">Status</th>
                    </tr>
                </thead>

                <tbody>
                    @foreach (var p in products)
                    {
                        var isLow = p.Quantity <= p.ReorderLevel;

                        <tr>
                            <td class="text-muted">@p.Id</td>
                            <td>@p.Name</td>
                            <td>@p.CategoryName</td>

                            <td class="text-end">@p.Cost.ToString("0.00")</td>
                            <td class="text-end">@p.Price.ToString("0.00")</td>
                            <td class="text-end">@p.ReorderLevel</td>
                            <td class="text-end">@p.Quantity</td>

                            <td class="text-center">
                                @if (isLow)
                                {
                                    <span class="badge bg-danger" title="Low stock">Low</span>
                                }
                                else
                                {
                                    <span class="badge bg-success" title="Stock OK">OK</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private bool isLoading;
    private string? errorMessage;

    private string searchText = "";
    private string selectedCategoryId = "";

    private List<ProductV5Dto> products = new();

    // categorias derivadas (não dependem de endpoint legacy)
    private List<CategoryVm> categories = new();

    private sealed class CategoryVm
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
    }

    protected override async Task OnInitializedAsync()
        => await LoadInitialAsync();

    private async Task LoadInitialAsync()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            // carrega produtos V5 e deriva categorias
            var all = await DashboardService.GetAllProductsAsync();

            categories = all
                .Where(p => !string.IsNullOrWhiteSpace(p.CategoryId))
                .GroupBy(p => p.CategoryId!, StringComparer.OrdinalIgnoreCase)
                .Select(g => new CategoryVm
                {
                    Id = g.Key,
                    Name = g.Select(x => x.CategoryName).FirstOrDefault(n => !string.IsNullOrWhiteSpace(n)) ?? g.Key
                })
                .OrderBy(c => c.Name)
                .ToList();

            // stock inicial (sem filtro)
            products = all;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading stock: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadStockAsync()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            var text = string.IsNullOrWhiteSpace(searchText) ? null : searchText;
            var cat = string.IsNullOrWhiteSpace(selectedCategoryId) ? null : selectedCategoryId;

            // ✅ V5-first
            products = await DashboardService.GetAllProductsAsync(text, cat);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading stock: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ResetFilters()
    {
        searchText = "";
        selectedCategoryId = "";

        await LoadStockAsync();
    }

    private async Task RefreshAsync()
    {
        await LoadStockAsync();
    }
}
