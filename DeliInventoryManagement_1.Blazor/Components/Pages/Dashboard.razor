@page "/dashboard"
@using DeliInventoryManagement_1.Blazor.Models
@using DeliInventoryManagement_1.Blazor.Models.V5
@inject DeliInventoryManagement_1.Blazor.Services.IDashboardService DashboardService
@inject NavigationManager NavManager
@rendermode InteractiveServer

<h3>Dashboard</h3>

@if (isLoading)
{
    <p>Loading...</p>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}
else
{
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="card-title">Total Products</h6>
                    <h3>@totalProducts</h3>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="card-title">Total Stock Quantity</h6>
                    <h3>@totalStockQty</h3>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="card-title">Today's Sales (Total)</h6>
                    <h3>@todaysSales</h3>
                    <small>(from V5 Sales)</small>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="card-title">Suppliers</h6>
                    <h3>—</h3>
                    <small>(coming in V5)</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-8">
            <h5>Low Stock (Top 5)</h5>

            @if (lowStockProducts.Count == 0)
            {
                <p>No low-stock items.</p>
            }
            else
            {
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Quantity</th>
                            <th>Reorder Level</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var p in lowStockProducts)
                        {
                            <tr>
                                <td>@p.Name</td>
                                <td>@p.CategoryName</td>
                                <td>@p.Quantity</td>
                                <td>@p.ReorderLevel</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>

        <div class="col-md-4">
            <h5>Quick Links</h5>
            <div class="d-grid gap-2">
                <NavLink class="btn btn-secondary" href="/products" Match="NavLinkMatch.Prefix">Products</NavLink>
                <NavLink class="btn btn-secondary" href="/stock" Match="NavLinkMatch.Prefix">Stock</NavLink>
                <NavLink class="btn btn-success" href="/sales" Match="NavLinkMatch.Prefix">Sales</NavLink>
                <NavLink class="btn btn-primary" href="/restock" Match="NavLinkMatch.Prefix">Restock</NavLink>
                <NavLink class="btn btn-info" href="/reports" Match="NavLinkMatch.Prefix">Reports</NavLink>
            </div>
        </div>
    </div>
}

@code {
    bool isLoading = true;
    string? errorMessage;

    int totalProducts;
    int totalStockQty;
    decimal todaysSales;

    List<ProductV5Dto> lowStockProducts = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            isLoading = true;

            var products = await DashboardService.GetAllProductsAsync();


            totalProducts = products.Count;
            totalStockQty = products.Sum(p => p.Quantity);

            lowStockProducts = products
                .Where(p => p.Quantity <= p.ReorderLevel)
                .OrderBy(p => p.Quantity)
                .Take(5)
                .ToList();

            var sales = await DashboardService.GetAllSalesAsync();

            var todayUtc = DateTime.UtcNow.Date;
            todaysSales = sales
                .Where(s => s.Date.Date == todayUtc)
                .Sum(s => s.Total);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading dashboard: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}
