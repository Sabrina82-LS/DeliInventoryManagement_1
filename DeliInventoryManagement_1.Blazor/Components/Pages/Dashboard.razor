@page "/dashboard"
@using DeliInventoryManagement_1.Blazor.Models
@using DeliInventoryManagement_1.Blazor.Models.V5
@inject DeliInventoryManagement_1.Blazor.Services.IDashboardService DashboardService
@inject NavigationManager NavManager
@rendermode InteractiveServer

<div class="dashboard-wrap">
    <h1 class="dashboard-title">Dashboard</h1>

    @if (isLoading)
    {
        <div class="panel">
            <p class="muted">Loading...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="panel panel-danger">
            <strong>Error:</strong> @errorMessage
        </div>
    }
    else
    {
        <!-- KPI Cards -->
        <section class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label">Total Products</div>
                <div class="kpi-value">@totalProducts</div>
            </div>

            <div class="kpi-card">
                <div class="kpi-label">Total Stock Quantity</div>
                <div class="kpi-value">@totalStockQty</div>
            </div>

            <div class="kpi-card">
                <div class="kpi-label">Today's Sales (Total)</div>
                <div class="kpi-value">@todaysSales</div>
                <div class="kpi-footnote">(from V5 Sales)</div>
            </div>

            <div class="kpi-card">
                <div class="kpi-label">Suppliers</div>
                <div class="kpi-value">—</div>
                <div class="kpi-footnote">(coming in V5)</div>
            </div>
        </section>

        <!-- Main content -->
        <section class="dashboard-grid">
            <!-- Low stock panel -->
            <div class="panel">
                <h2 class="panel-title">Low Stock (Top 5)</h2>

                @if (lowStockProducts.Count == 0)
                {
                    <p class="muted">No low-stock items.</p>
                }
                else
                {
                    <div class="table-wrap">
                        <table class="table-clean">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th class="num">Quantity</th>
                                    <th class="num">Reorder Level</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var p in lowStockProducts)
                                {
                                    <tr>
                                        <td>@p.Name</td>
                                        <td class="muted">@p.CategoryName</td>
                                        <td class="num">@p.Quantity</td>
                                        <td class="num">@p.ReorderLevel</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>

            <!-- Quick links panel -->
            <div class="panel">
                <h2 class="panel-title">Quick Links</h2>

                <div class="quick-links">
                    <NavLink class="quick-link btn-products" href="/products" Match="NavLinkMatch.Prefix">Products</NavLink>
                    <NavLink class="quick-link btn-stock" href="/stock" Match="NavLinkMatch.Prefix">Stock</NavLink>
                    <NavLink class="quick-link btn-sales" href="/sales" Match="NavLinkMatch.Prefix">Sales</NavLink>
                    <NavLink class="quick-link btn-restocks" href="/restocks" Match="NavLinkMatch.Prefix">Restocks</NavLink>
                    <NavLink class="quick-link btn-reports" href="/reports" Match="NavLinkMatch.Prefix">Reports</NavLink>
                </div>
            </div>
        </section>
    }
</div>

@code {
    bool isLoading = true;
    string? errorMessage;

    int totalProducts;
    int totalStockQty;
    decimal todaysSales;

    List<ProductV5Dto> lowStockProducts = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            isLoading = true;

            var products = await DashboardService.GetAllProductsAsync();

            totalProducts = products.Count;
            totalStockQty = products.Sum(p => p.Quantity);

            lowStockProducts = products
                .Where(p => p.Quantity <= p.ReorderLevel)
                .OrderBy(p => p.Quantity)
                .Take(5)
                .ToList();

            var sales = await DashboardService.GetAllSalesAsync();

            var todayUtc = DateTime.UtcNow.Date;
            todaysSales = sales
                .Where(s => s.Date.Date == todayUtc)
                .Sum(s => s.Total);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading dashboard: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}
