@page "/restocks"
@rendermode InteractiveServer
@using DeliInventoryManagement_1.Blazor.Models
@using DeliInventoryManagement_1.Blazor.Services

@inject IRestockService RestockService
@inject IDashboardService DashboardService


<h3>Restocks</h3>

@if (isLoading)
{
    <p>Loading products and suppliers...</p>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}
else
{
    <!-- ============================
         CARD: NEW RESTOCK (HEADER)
         ============================ -->
    <div class="card mb-3">
        <div class="card-header">New Restock</div>

        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-3">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-control" @bind="restockDate" />
                </div>

                <div class="col-md-5">
                    <label class="form-label">Supplier</label>
                    <select class="form-select" @bind="selectedSupplierId">
                        <option value="">-- Select supplier --</option>
                        @foreach (var s in suppliers)
                        {
                            <option value="@s.Id">@s.Id - @s.Name</option>
                        }
                    </select>
                </div>
            </div>

            <hr />

            <!-- ============================
                 ADD LINE
                 ============================ -->
            <div class="row mb-3">
                <div class="col-md-5">
                    <label class="form-label">Product</label>
                    <select class="form-select" @bind="selectedProductId">
                        <option value="">-- Select product --</option>
                        @foreach (var p in products)
                        {
                            <option value="@p.Id">@p.Id - @p.Name (@p.CategoryName)</option>
                        }
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label">Quantity</label>
                    <input type="number" min="1" class="form-control" @bind="lineQuantity" />
                </div>

                <div class="col-md-2">
                    <label class="form-label">Cost / unit</label>
                    <input type="number" step="0.01" min="0" class="form-control" @bind="lineUnitCost" />
                </div>

                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-primary w-100" @onclick="AddLine">
                        Add line
                    </button>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(lineError))
            {
                <div class="alert alert-warning mb-0">@lineError</div>
            }
        </div>
    </div>

    <!-- ============================
         CARD: RESTOCK LINES
         ============================ -->
    <div class="card mb-3">
        <div class="card-header">Restock Lines</div>

        <div class="card-body">
            @if (lines.Count == 0)
            {
                <p class="mb-0">No lines added yet.</p>
            }
            else
            {
                <table class="table table-sm align-middle">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th class="text-end">Qty</th>
                            <th class="text-end">Unit Cost</th>
                            <th class="text-end">Line Total</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var l in lines)
                        {
                            <tr>
                                <td>@l.ProductId - @l.ProductName</td>
                                <td class="text-end">@l.Quantity</td>
                                <td class="text-end">@l.UnitCost.ToString("0.00")</td>
                                <td class="text-end">@l.Total.ToString("0.00")</td>
                                <td class="text-end">
                                    <button class="btn btn-link btn-sm" @onclick="() => RemoveLine(l)">
                                        Remove
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>

                <div class="text-end fw-bold">
                    Total cost: @totalCost.ToString("0.00")
                </div>
            }
        </div>

        <div class="card-footer text-end">
            <button class="btn btn-success"
                    @onclick="SaveRestockAsync"
                    disabled="@(!CanSave || isSaving)">
                @(isSaving ? "Saving..." : "Save Restock")
            </button>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success">@successMessage</div>
    }

    @if (!string.IsNullOrEmpty(saveError))
    {
        <div class="alert alert-danger">@saveError</div>
    }
}

@code {
    // ============================
    // STATE
    // ============================
    private bool isLoading;
    private bool isSaving;

    private string? errorMessage;   // erro ao carregar dados
    private string? lineError;      // erro ao adicionar linha
    private string? successMessage; // sucesso ao salvar
    private string? saveError;      // erro ao salvar

    private List<ProductDto> products = new();
    private List<SupplierDto> suppliers = new();

    // Header (Restock)
    private DateTime restockDate = DateTime.Today;
    private string selectedSupplierId = "";

    // New line inputs
    private string selectedProductId = "";
    private int lineQuantity = 1;
    private decimal lineUnitCost = 0m;

    // Lines VM
    private List<RestockLineVm> lines = new();

    private decimal totalCost => lines.Sum(l => l.Total);

    private bool CanSave =>
        !string.IsNullOrWhiteSpace(selectedSupplierId) &&
        lines.Count > 0;

    // ============================
    // VIEWMODEL
    // ============================
    private sealed class RestockLineVm
    {
        public string ProductId { get; set; } = string.Empty;
        public string ProductName { get; set; } = string.Empty;
        public int Quantity { get; set; }
        public decimal UnitCost { get; set; }
        public decimal Total => Quantity * UnitCost;
    }

    // ============================
    // INIT
    // ============================
    protected override async Task OnInitializedAsync()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            // Carrega dados para os selects
            products = await DashboardService.GetAllProductsAsync(null, null);
            suppliers = await DashboardService.GetAllSuppliersAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    // ============================
    // ADD / REMOVE LINE
    // ============================
    private void AddLine()
    {
        lineError = null;
        successMessage = null;
        saveError = null;

        if (string.IsNullOrWhiteSpace(selectedSupplierId))
        {
            lineError = "Select a supplier first.";
            return;
        }

        if (string.IsNullOrWhiteSpace(selectedProductId))
        {
            lineError = "Select a product.";
            return;
        }

        if (lineQuantity <= 0)
        {
            lineError = "Quantity must be > 0.";
            return;
        }

        if (lineUnitCost <= 0)
        {
            lineError = "Cost / unit must be > 0.";
            return;
        }

        var product = products.FirstOrDefault(p => p.Id == selectedProductId);
        if (product is null)
        {
            lineError = "Selected product not found.";
            return;
        }

        // ✅ Se já existe a mesma linha, soma quantidade (evita duplicar produto)
        var existing = lines.FirstOrDefault(l => l.ProductId == product.Id);
        if (existing is not null)
        {
            existing.Quantity += lineQuantity;
            existing.UnitCost = lineUnitCost; // mantém último custo informado (simples)
        }
        else
        {
            lines.Add(new RestockLineVm
            {
                ProductId = product.Id,
                ProductName = product.Name,
                Quantity = lineQuantity,
                UnitCost = lineUnitCost
            });
        }

        // Reset inputs
        selectedProductId = "";
        lineQuantity = 1;
        lineUnitCost = 0m;
    }

    private void RemoveLine(RestockLineVm line)
    {
        lines.Remove(line);
    }

    // ============================
    // SAVE (CALL API)
    // ============================
    private async Task SaveRestockAsync()
    {
        lineError = null;
        successMessage = null;
        saveError = null;

        if (!CanSave)
        {
            saveError = "Please select a supplier and add at least one line.";
            return;
        }

        var supplier = suppliers.FirstOrDefault(s => s.Id == selectedSupplierId);
        if (supplier is null)
        {
            saveError = "Selected supplier not found.";
            return;
        }

        // ✅ Monta o request para a API (POST /api/restocks)
        var request = new CreateRestockRequest
        {
            Date = restockDate,
            SupplierId = supplier.Id,
            SupplierName = supplier.Name,
            Lines = lines.Select(l => new CreateRestockLineRequest
            {
                ProductId = l.ProductId,
                ProductName = l.ProductName,
                Quantity = l.Quantity,
                CostPerUnit = l.UnitCost
            }).ToList()
        };

        try
        {
            isSaving = true;

            // ✅ Chama a API (ela salva Restock e aumenta o stock no Cosmos)
            await RestockService.CreateAsync(request);

            successMessage = $"Restock saved ✔️ {lines.Count} line(s) - Total {totalCost:0.00}. Stock updated in Cosmos.";

            // Reset form
            restockDate = DateTime.Today;
            selectedSupplierId = "";
            selectedProductId = "";
            lineQuantity = 1;
            lineUnitCost = 0m;
            lines.Clear();
        }
        catch (Exception ex)
        {
            saveError = $"Error saving restock: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }
}
